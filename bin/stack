#!/usr/bin/env bash
set -euo pipefail

VERSION="0.2.3"

# ---------- Defaults ----------
COMPOSE_FILES=("docker-compose.yml")
ENV_FILE=".env"

# Default stack name = folder name, overridden by APP in .stackrc/.env
STACK_NAME_DEFAULT="${APP:-$(basename "$(pwd)")}"

DETACH="${DETACH:-false}"
WAIT_TIMEOUT="${WAIT_TIMEOUT:-300}"
CONTEXT="${DOCKER_CONTEXT:-}"

# ---------- Helpers ----------
die(){ echo "❌ $*" >&2; exit 1; }
info(){ echo "➤ $*"; }
ok(){ echo "✅ $*"; }

compose_args() {
  args=()
  for f in "${COMPOSE_FILES[@]}"; do
    [[ -f "$f" ]] || die "Compose file not found: $f"
    args+=(-c "$f")
  done
  printf "%s " "${args[@]}"
}

stack_name() {
  name="${STACK_NAME_DEFAULT}"

  # Load from .stackrc first (priority 1)
  [[ -f ".stackrc" ]] && set +u && . ".stackrc" && set -u && name="${APP:-$name}"

  # Load from .env second (priority 2)
  [[ -f "$ENV_FILE" ]] && set +u && . "$ENV_FILE" && set -u && name="${APP:-$name}"

  printf "%s" "$name"
}

require_swarm() {
  docker info --format '{{.Swarm.LocalNodeState}}' | grep -qE 'active|manager' \
    || die "Docker Swarm inactive on this node. Run: docker swarm init"
}

use_context() {
  if [[ -n "$CONTEXT" ]]; then
    info "Using docker context: $CONTEXT"
    docker context use "$CONTEXT" >/dev/null
  fi
}

wait_ready() {
  stack="$1"
  deadline=$(( $(date +%s) + WAIT_TIMEOUT ))
  info "Waiting for stack '$stack' to become ready (timeout: ${WAIT_TIMEOUT}s)…"
  while true; do
    mapfile -t states < <(docker stack ps "$stack" --no-trunc --format '{{.CurrentState}}' 2>/dev/null || true)
    total=${#states[@]}
    if (( total == 0 )); then
      [[ $(date +%s) -lt $deadline ]] && sleep 1 && continue || die "No tasks yet for $stack."
    fi
    running=0
    for s in "${states[@]}"; do [[ "$s" =~ ^Running\ |^Complete\  ]] && ((running++)); done
    if (( running == total )); then ok "All $total tasks running/complete."; return 0; fi
    [[ $(date +%s) -ge $deadline ]] && die "Timed out waiting for stack readiness."
    sleep 2
  done
}

usage() {
cat <<EOF
stack-manager ${VERSION}

Usage:
  stack [command]

Commands:
  up            Deploy/update the stack in current directory
  down|rm       Remove the stack
  ps            Show services/tasks
  logs          Tail logs of all services
  redeploy      Force update of all services (rolling)
  wait          Wait until tasks running/complete
  prune         Prune unused docker objects
  --help        Show this help
  --version     Show version

Environment files:
  .stackrc  - Stack-specific configuration (APP, COMPOSE_FILES, etc.)
  .env      - Environment variables passed to compose

Examples:
  stack up
  stack down
  stack ps
  DETACH=true stack up
EOF
}

[[ "${1:-}" == "--help" ]] && usage && exit 0
[[ "${1:-}" == "--version" ]] && echo "$VERSION" && exit 0

cmd="${1:-}"; shift || true

case "$cmd" in
  up)
    [[ -f ".stackrc" ]] && set +u && . ".stackrc" && set -u
    if [[ -f "$ENV_FILE" ]]; then
        set -a
        . "$ENV_FILE"
        set +a
        info "Loaded .env"
    fi
    use_context
    require_swarm
    name="$(stack_name)"
    info "Deploying stack '$name'"
    # shellcheck disable=SC2046
    docker stack deploy $(compose_args) --with-registry-auth --prune --detach="$DETACH" "$name"
    [[ "$DETACH" == "false" ]] && wait_ready "$name"
    ok "Deployed $name"
    ;;
  down|rm)
    use_context
    name="$(stack_name)"
    info "Removing stack '$name'"
    docker stack rm "$name" || true
    ok "Remove requested for $name"
    ;;
  ps)
    use_context
    name="$(stack_name)"
    docker stack services "$name"
    echo
    docker stack ps "$name" --no-trunc
    ;;
  logs)
    use_context
    name="$(stack_name)"
    docker service ls --format '{{.Name}}' | grep -E "^${name}_" | xargs -r docker service logs -f --since=10m
    ;;
  redeploy)
    use_context
    name="$(stack_name)"
    docker service ls --format '{{.Name}}' | grep -E "^${name}_" | while read -r svc; do
      docker service update --force --label-add "redeploy-ts=$(date +%s)" "$svc"
    done
    ;;
  wait)
    use_context
    name="$(stack_name)"
    wait_ready "$name"
    ;;
  prune)
    use_context
    docker system prune -f
    ;;
  "")
    usage
    ;;
  *)
    die "Unknown command: $cmd"
    ;;
esac
